---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import AppForm from "../components/AppForm.tsx";
import { app } from "../firebase/server";
import { getAuth } from "firebase-admin/auth";

let userEmail = "";

try {
  const auth = getAuth(app);
  const sessionCookieObj = Astro.cookies.get("__session");
  if (!sessionCookieObj) {
    return Astro.redirect("/");
  }
  const sessionCookie = sessionCookieObj.value;
  const decodedCookie = await auth.verifySessionCookie(sessionCookie);
  if (!decodedCookie) {
    return Astro.redirect("/");
  }

  const user = await auth.getUser(decodedCookie.uid);

  if (!user) {
    return Astro.redirect("/");
  }
  userEmail = user.email as string;
} catch (err) {
  console.error(err);
  return Astro.redirect("/");
}
---

<DashboardLayout>
  <AppForm email={userEmail} client:only="react" />
</DashboardLayout>
