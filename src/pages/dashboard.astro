---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import { app, db } from "../firebase/server";
import { getAuth } from "firebase-admin/auth";

let userEmail;
let userName;
let userPhoto;
let registered = false
let result = false

try {
  const auth = getAuth(app);
  const sessionCookieObj = Astro.cookies.get("__session");
  if (!sessionCookieObj) {
    return Astro.redirect("/");
  }
  const sessionCookie = sessionCookieObj.value;
  const decodedCookie = await auth.verifySessionCookie(sessionCookie);
  if (!decodedCookie) {
    return Astro.redirect("/");
  }

  const user = await auth.getUser(decodedCookie.uid);

  if (!user) {
    return Astro.redirect("/");
  }
  userEmail = user.email;
  userName = user.displayName;
  userPhoto = user.photoURL

  // check if the user already register the application:
  const docSnap = await db.collection("Forms").doc(decodedCookie.email as string).get()
  if (docSnap.exists) {
    registered = true
  }

} catch (err) {
  console.error(err);
  return Astro.redirect("/");
}
---

<DashboardLayout>
  <section class="user-info">
    <h1>Welcome {userName}!</h1>
  </section>
  <section class="dashboard-result" style={(result)? "" : "display: none"}>
    <strong>Result of application:</strong>
  </section>
  <section>
  </section>
  <section class="dashboard-app">
    <div style="display: flex; justify-content: space-between; align-items: center">
      <h2>Application to SparkHacks</h2>
      <div><strong>Close at:</strong> 11:59:59 pm 01/18/2024</div>
    </div>
    <div>Application Status: <strong>{(registered)? "Submitted" : "Not started"}</strong></div>
    <button id="app-btn">
      {(registered)? "View Application" : "Start Application"}
    </button>
  </section>
  <script>
    const appBtn = document.getElementById("app-btn");
    appBtn?.addEventListener("click", () => {
      window.location.assign("/application");
    });
  </script>
</DashboardLayout>
<style>
  .user-info {
    width: 1000px;
    max-width: 100%;
    margin-top: 70px;
  }
  .dashboard-result {
    box-sizing: border-box;
    width: 1000px;
    max-width: 100%;
    margin-top: 20px;
    border-radius: 4px;
    background-color: #f88378; /*#afd9ae; */
    padding: 20px;

  }
  .dashboard-app {
    box-sizing: border-box;
    width: 1000px;
    max-width: 100%;
    margin-top: 20px;
    padding: 20px;
    border-radius: 4px;
    border: 1px solid;
  }
  #app-btn {
    margin-top: 16px;
    width: 100%;
    padding: 16px 32px;
    background-color: #43b3ae;
    /* color: white; */
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #app-btn:hover {
    filter: brightness(80%);
  }
</style>
